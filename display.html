<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Display de Cronómetros</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

/* GRID PRINCIPAL */
.grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 10px;
    width: 100vw;
    height: 100vh;
    padding: 10px;
    box-sizing: border-box;
}

/* TARJETA DE CADA CRONÓMETRO */
.timer {
    background: #111;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* TEXTO "GRUPO X" */
.label {
    font-size: clamp(14px, 1.8vw, 22px);
    opacity: 0.8;
    margin-bottom: 5px;
}

/* TIEMPO MM:SS */
.time {
    font-size: clamp(32px, 6vw, 80px);
    font-weight: bold;
    letter-spacing: 2px;
}
</style>
</head>

<body>

<div class="grid" id="grid"></div>

<script type="module">
import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, onSnapshot }
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ======================
   FIREBASE CONFIG
   ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAJqYhseyN-s6s79WxFlljQlKNSkMRkptE",
  authDomain: "cronometros-grupos.firebaseapp.com",
  projectId: "cronometros-grupos",
  storageBucket: "cronometros-grupos.firebasestorage.app",
  messagingSenderId: "886340826784",
  appId: "1:886340826784:web:63897dd9170825bc15fbc5",
  measurementId: "G-KD241WKQZ2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ======================
   CREAR UI (20 GRUPOS)
   ====================== */
const grid = document.getElementById("grid");
const timers = {};

for (let i = 1; i <= 20; i++) {
    const div = document.createElement("div");
    div.className = "timer";
    div.innerHTML = `
        <div class="label">Grupo ${i}</div>
        <div class="time" id="time${i}">00:00</div>
    `;
    grid.appendChild(div);

    timers[i] = {
        running: false,
        startTime: 0,
        elapsed: 0
    };
}

/* ======================
   FORMATO MM:SS con límite 99:99
   ====================== */
function formatTime(ms) {
    let totalSeconds = Math.floor(ms / 1000);
    let minutes = Math.floor(totalSeconds / 60);
    let seconds = totalSeconds % 60;

    if (minutes > 99) minutes = 99;
    if (seconds > 99) seconds = 99;

    return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
}

/* ======================
   ESCUCHAR FIRESTORE
   ====================== */
for (let i = 1; i <= 20; i++) {
    const ref = doc(db, "cronometros", "grupo" + i);

    onSnapshot(ref, (snap) => {
        if (!snap.exists()) return;

        const data = snap.data();
        timers[i].running = data.running;
        timers[i].startTime = data.startTime || 0;
        timers[i].elapsed = data.elapsed || 0;
    });
}

/* ======================
   LOOP DE ACTUALIZACIÓN
   ====================== */
setInterval(() => {
    const now = Date.now();

    for (let i = 1; i <= 20; i++) {
        let ms = timers[i].elapsed;

        if (timers[i].running && timers[i].startTime) {
            ms += now - timers[i].startTime;
        }

        if (ms > 99 * 60 * 1000 + 99 * 1000) {
            ms = 99 * 60 * 1000 + 99 * 1000;
        }

        document.getElementById("time" + i).innerText = formatTime(ms);
    }
}, 500);
</script>

</body>
</html>
